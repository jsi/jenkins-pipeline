java.lang.String concat(String a, String b) {
    a + b;
}

stage ('1') {
    node('Node-1') {
            echo "Workspace: ${env.WORKSPACE}"
            timestamps {
                echo "Build Tag: ${env.BUILD_TAG}"
            }
            git url: 'https://github.com/enonic/app-features'
            def v = version()
            if (v) {
                def message = concat("Building version ", v)
                echo message
            }
        echo "Plugins used:"
        new File('build.gradle').eachLine { line ->
           if (line.startsWith("apply plugin:")) {
               timestamps {
                   println line.substring(13)
               }
           } 
        }
    }
}

stage ('2') {
    parallel 'pull-purple-js':{
        node ('Node-1') {
            timestamps {
                echo "Version: 0.1.${env.BUILD_NUMBER}"
            }
            echo "Java home: ${env.JAVA_HOME}"
            git url: 'https://github.com/purplejs/purplejs'
        }
    }, 'install-maven3':{
        node ('Node-2') {
            def m3Home = tool 'M3'
            echo m3Home
        }
    }
}

stage ('3') {
    node ('Node-1') {
        sh "./gradlew --daemon build"
        def gradleHome = tool 'Gradle'
        echo gradleHome
        def m3Home = tool 'M3'
        echo m3Home
    }
}

def version() {
    def matcher = readFile('gradle.properties') =~ 'version = (.+)'
    matcher ? matcher[0][1] : null
}
